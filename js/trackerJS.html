<script>

    // call on its own to insert a new element after the reference
    function insertAfter(newNode, referenceNode)
    {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }

    /* ADD PLAYER MODAL --------------------------------------*/
    var modal = document.getElementById("add-player-modal");

    // Get the button that opens the modal
    var btn = document.getElementById("insert-player-btn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    btn.onclick = function() {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    /*--------------------------------------------------------*/

    function insertPlayerBlock(player)
    {
        // create player block div
        let playerDiv = document.createElement("div");
        playerDiv.classList.add("player-block");
        playerDiv.id = player.name;

        // header
        let playerName = document.createElement("h1");
        playerName.innerHTML = player.name;
        playerDiv.appendChild(playerName);

        // passive perception
        let perception = document.createElement("p");
        perception.id = player.name + "-perception";
        perception.innerHTML = "<b>Passive Perception: </b>" + player.perception;
        playerDiv.appendChild(perception);

        // conmod
        let conmod = document.createElement("p");
        conmod.id = player.name + "-conmod";
        conmod.innerHTML = "<b>Constitution Modifier: </b>" + player.conmod;
        playerDiv.appendChild(conmod);

        // hunger
        let hunger = document.createElement("p");
        hunger.id = player.name + "-hunger";
        hunger.innerHTML = "<b>Hunger Status: </b>" + player.hunger;
        playerDiv.appendChild(hunger);

        // thirst
        let thirst = document.createElement("p");
        thirst.id = player.name + "-thirst";
        thirst.innerHTML = "<b>Hydration Status: </b>" + player.thirst;
        playerDiv.appendChild(thirst);

        // exhaustion
        let exhaustion = document.createElement("p");
        exhaustion.id = player.name + "-exhaustion";
        exhaustion.innerHTML = "<b>Exhaustion Level: </b>" + player.exhaustion;
        playerDiv.appendChild(exhaustion);

        // select section
        let playerForm = document.createElement("form");
        let selectContainer = document.createElement("div");
        selectContainer.classList.add("select-container");
        playerForm.appendChild(selectContainer);
        playerDiv.appendChild(playerForm);

        // eating rate
        let eatingDiv = document.createElement("div");

        let eatingLabel = document.createElement("label");
        eatingLabel.innerHTML = "FOOD: ";
        eatingLabel.setAttribute("for", player.name + "-eating-rate");

        let eatingSelect = document.createElement("select");
        eatingSelect.id = player.name + "-eating-rate";
        eatingSelect.setAttribute("name", player.name + "eatingRate");
        eatingSelect.value = player.eatingRate;

        let eatOption0 = document.createElement("option");
        eatOption0.value = "0";
        eatOption0.innerHTML = "0 lb/day";

        let eatOption1 = document.createElement("option");
        eatOption1.value = "0.5";
        eatOption1.innerHTML = "0.5 lb/day";

        let eatOption2 = document.createElement("option");
        eatOption2.value = "1";
        eatOption2.innerHTML = "1 lb/day";

        // adding eating rate div
        eatingSelect.appendChild(eatOption0);
        eatingSelect.appendChild(eatOption1);
        eatingSelect.appendChild(eatOption2);
        eatingDiv.appendChild(eatingLabel);
        eatingDiv.appendChild(eatingSelect);
        selectContainer.appendChild(eatingDiv);

        // drinking rate
        let drinkingDiv = document.createElement("div");

        let drinkingLabel = document.createElement("label");
        drinkingLabel.innerHTML = "H2O: ";
        drinkingLabel.setAttribute("for", player.name + "-drinking-rate");

        let drinkingSelect = document.createElement("select");
        drinkingSelect.id = player.name + "-drinking-rate";
        drinkingSelect.setAttribute("name", player.name + "drinkingRate");

        let drinkOption0 = document.createElement("option");
        drinkOption0.value = "0";
        drinkOption0.innerHTML = "0 gal/day";

        let drinkOption1 = document.createElement("option");
        drinkOption1.value = "0.5";
        drinkOption1.innerHTML = "0.5 gal/day";

        let drinkOption2 = document.createElement("option");
        drinkOption2.value = "1";
        drinkOption2.innerHTML = "1 gal/day";

        let drinkOption3 = document.createElement("option");
        drinkOption3.value = "2";
        drinkOption3.innerHTML = "2 gal/day";

        // adding drinking rate div
        drinkingSelect.appendChild(drinkOption0);
        drinkingSelect.appendChild(drinkOption1);
        drinkingSelect.appendChild(drinkOption2);
        drinkingSelect.appendChild(drinkOption3);
        drinkingDiv.appendChild(drinkingLabel);
        drinkingDiv.appendChild(drinkingSelect);
        selectContainer.appendChild(drinkingDiv);

        // marching order
        let marchingDiv = document.createElement("div");

        let marchingLabel = document.createElement("label");
        marchingLabel.innerHTML = "ORDER: ";
        marchingLabel.setAttribute("for", player.name + "-marching-order");

        let marchingSelect = document.createElement("select");
        marchingSelect.id = player.name + "-marching-order";
        marchingSelect.setAttribute("name", player.name + "marchingOrder");

        let marchOption0 = document.createElement("option");
        marchOption0.value = "Front";
        marchOption0.innerHTML = "Front";

        let marchOption1 = document.createElement("option");
        marchOption1.value = "Middle";
        marchOption1.innerHTML = "Middle";

        let marchOption2 = document.createElement("option");
        marchOption2.value = "Back";
        marchOption2.innerHTML = "Back";

        // adding marching order div
        marchingSelect.appendChild(marchOption0);
        marchingSelect.appendChild(marchOption1);
        marchingSelect.appendChild(marchOption2);
        marchingDiv.appendChild(marchingLabel);
        marchingDiv.appendChild(marchingSelect);
        selectContainer.appendChild(marchingDiv);

        // lifestyle
        let lifestyleDiv = document.createElement("div");

        let lifestyleLabel = document.createElement("label");
        lifestyleLabel.innerHTML = "LIFE: ";
        lifestyleLabel.setAttribute("for", player.name + "-lifestyle");

        let lifestyleSelect = document.createElement("select");
        lifestyleSelect.id = player.name + "-lifestyle";
        lifestyleSelect.setAttribute("name", player.name + "lifestyle");

        let lifestyleOption0 = document.createElement("option");
        lifestyleOption0.value = "Squalid";
        lifestyleOption0.innerHTML = "Squalid";

        let lifestyleOption1 = document.createElement("option");
        lifestyleOption1.value = "Poor";
        lifestyleOption1.innerHTML = "Poor";

        let lifestyleOption2 = document.createElement("option");
        lifestyleOption2.value = "Modest";
        lifestyleOption2.innerHTML = "Modest";

        let lifestyleOption3 = document.createElement("option");
        lifestyleOption3.value = "Comfortable";
        lifestyleOption3.innerHTML = "Comfortable";

        let lifestyleOption4 = document.createElement("option");
        lifestyleOption4.value = "Wealthy";
        lifestyleOption4.innerHTML = "Wealthy";

        let lifestyleOption5 = document.createElement("option");
        lifestyleOption5.value = "Aristocratic";
        lifestyleOption5.innerHTML = "Aristocratic";

        // adding lifestyle rate div
        lifestyleSelect.appendChild(lifestyleOption0);
        lifestyleSelect.appendChild(lifestyleOption1);
        lifestyleSelect.appendChild(lifestyleOption2);
        lifestyleSelect.appendChild(lifestyleOption3);
        lifestyleSelect.appendChild(lifestyleOption4);
        lifestyleSelect.appendChild(lifestyleOption5);
        lifestyleDiv.appendChild(lifestyleLabel);
        lifestyleDiv.appendChild(lifestyleSelect);
        selectContainer.appendChild(lifestyleDiv);

        // button bar
        let buttonDiv = document.createElement("div");
        buttonDiv.classList.add("player-btn-bar");

        // eat button
        let eatBtnDiv = document.createElement("div");
        let eatBtn = document.createElement("button");
        eatBtn.innerHTML = "Eat";
        eatBtnDiv.appendChild(eatBtn);

        // drink button
        let drinkBtnDiv = document.createElement("div");
        let drinkBtn = document.createElement("button");
        drinkBtn.innerHTML = "Drink";
        drinkBtnDiv.appendChild(drinkBtn);

        // add buttons to block
        buttonDiv.appendChild(eatBtnDiv);
        buttonDiv.appendChild(drinkBtnDiv);
        playerDiv.appendChild(buttonDiv);

        // hidden stats
        let hiddenObject = document.createElement("p");
        hiddenObject.classList.add("hidden-object-data");
        hiddenObject.innerHTML = JSON.stringify(player);
        playerDiv.appendChild(hiddenObject);


        // add block to grid
        let playerGrid = document.getElementById("player-grid");
        playerGrid.appendChild(playerDiv);

        // set selects
        lifestyleSelect.value = player.lifestyle;
        marchingSelect.value = player.order;
        drinkingSelect.value = player.drinkingRate;
        eatingSelect.value = player.eatingRate;
    }

    function checkGridForDuplicates(name, playerGrid)
    {
        for (let i = 0; i < playerGrid.childElementCount; i++)
        {
            let currentBlock = playerGrid.children[i].id;
            if (currentBlock === name)
            {
                // duplicate found
                return true;
            }
        }

        // no duplicate
        return false;
    }

    function collectPlayersToAdd()
    {
        let playersToAdd = [];
        let playerList = document.getElementById("player-list");
        let count = playerList.childElementCount;

        for (let i = 0; i < count; i++)
        {
            // if box is checked, add player json as object to be added
            let currentPlayer = playerList.children[i];

            // skip if hr tag
            if (currentPlayer.tagName === "HR")
            {
                continue;
            }

            let checkbox = currentPlayer.getElementsByTagName("input")[0];
            if (checkbox.checked)
            {
                // parse json from hidden paragraph and push
                let playerJSON = JSON.parse(currentPlayer.getElementsByTagName("p")[0].innerHTML);
                playersToAdd.push(playerJSON);
            }
        }

        // check that there are enough empty blocks to add these players
        let status = document.getElementById("player-status");
        let playerGrid = document.getElementById("player-grid");
        let currentBlockCount = playerGrid.childElementCount;

        if (playersToAdd.length + currentBlockCount > 8)
        {
            status.innerHTML = "There are not enough empty slots.";
        }
        else
        {
            let addCount = playersToAdd.length;
            for (let i = 0; i < playersToAdd.length; i++)
            {
                // skip if player has already been added
                if (checkGridForDuplicates(playersToAdd[i].name, playerGrid))
                {
                    addCount--;
                    continue;
                }

                insertPlayerBlock(playersToAdd[i]);
            }
            status.innerHTML = addCount + " players added";
        }
    }

    function displayPlayerList(playerList)
    {
        // no items in list
        if (playerList.length === 0)
        {
            // hide the loader
            let loader = document.getElementById("player-list-loader");
            loader.style.display = "none";

            // update status
            document.getElementById("player-status").innerHTML = "No players created.";
        }
        else
        {
            // hide the loader
            let loader = document.getElementById("player-list-loader");
            loader.style.display = "none";

            // update status
            document.getElementById("player-status").innerHTML = "Displaying " + playerList.length + " players."; 

            // create a div to contain the list
            let listDiv = document.createElement("div");
            listDiv.id = "player-list";
            let targetDiv = document.getElementById("player-collapse-target");
            insertAfter(listDiv, targetDiv);

            for (let i = 0; i < playerList.length; i++)
            {
                let newDiv = document.createElement("div");         // create new div
                newDiv.id = "player-" + playerList[i].name;

                let newButton = document.createElement("h3");       // create button to place in the div
                newButton.innerHTML = playerList[i].name;           // add text to the button
                newButton.classList.add("name-row");

                newDiv.appendChild(newButton);                      // attach button to parent div

                // checkbox
                let newCheck = document.createElement("input");
                newCheck.setAttribute("type", "checkbox");
                newCheck.value = "checked";
                newCheck.classList.add("name-row");
                newCheck.classList.add("name-checkbox");

                // checkbox to div
                newDiv.appendChild(newCheck);

                // storing the json for later
                let hiddenObject = document.createElement("p");
                hiddenObject.classList.add("hidden-object-data");
                hiddenObject.innerHTML = JSON.stringify(playerList[i]);
                newDiv.appendChild(hiddenObject);

                // add div to playerList div
                listDiv.appendChild(newDiv);

                // add an hr if this isn't the last child
                if (i < playerList.length - 1)
                {
                    let newHr = document.createElement("hr");
                    listDiv.appendChild(newHr);
                }
            }
        }
    }

    function loadTrackerLists()
    {
        // if the playerList div exists, delete it
        if (document.contains(document.getElementById("player-list")))
        {
            document.getElementById("player-list").remove();
        }

        // show loading circle
        let loader = document.getElementById("player-list-loader");
        loader.style.display = "block";

        // display loading message
        document.getElementById("player-status").innerHTML = "Loading player list...";

        // load in array and pass to display function
        google.script.run.withSuccessHandler(displayPlayerList).generateObjectArray('DMAssistantPlayers', 'playerList.json');
    }

    // -------------- TRAVEL ---------------- //

    function travel()
    {
        let narrator = document.getElementById("narrator");

        // TEST CODE
        let updateText = document.createElement("p");
        updateText.innerHTML = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent ornare tincidunt tellus at ornare. Nulla non suscipit sem. Quisque vel enim non elit porttitor scelerisque nec ut mauris. Quisque commodo odio sem, nec pulvinar urna vehicula ac.";
        narrator.appendChild(updateText);
    }

</script>