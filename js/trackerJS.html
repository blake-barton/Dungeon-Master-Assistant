<script>

    // call on its own to insert a new element after the reference
    function insertAfter(newNode, referenceNode)
    {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }

    /* ADD PLAYER MODAL --------------------------------------*/
    var modal = document.getElementById("add-player-modal");

    // Get the button that opens the modal
    var btn = document.getElementById("insert-player-btn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    btn.onclick = function() {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    /*--------------------------------------------------------*/

    function insertPlayerBlock(player)
    {
        // create player block div
        let playerDiv = document.createElement("div");
        playerDiv.classList.add("player-block");
        playerDiv.id = player.name;

        // header
        let playerName = document.createElement("h1");
        playerName.innerHTML = player.name;
        playerDiv.appendChild(playerName);

        // passive perception
        let perception = document.createElement("p");
        perception.id = player.name + "-perception";
        perception.innerHTML = "<b>Passive Perception: </b>" + player.perception;
        playerDiv.appendChild(perception);

        // conmod
        let conmod = document.createElement("p");
        conmod.id = player.name + "-conmod";
        conmod.innerHTML = "<b>Constitution Modifier: </b>" + player.conmod;
        playerDiv.appendChild(conmod);

        // hunger
        let hunger = document.createElement("p");
        hunger.id = player.name + "-hunger";
        hunger.innerHTML = "<b>Hunger Status: </b>" + player.hunger;
        playerDiv.appendChild(hunger);

        // thirst
        let thirst = document.createElement("p");
        thirst.id = player.name + "-thirst";
        thirst.innerHTML = "<b>Hydration Status: </b>" + player.thirst;
        playerDiv.appendChild(thirst);

        // exhaustion
        let exhaustion = document.createElement("p");
        exhaustion.id = player.name + "-exhaustion";
        exhaustion.innerHTML = "<b>Exhaustion Level: </b>" + player.exhaustion;
        playerDiv.appendChild(exhaustion);

        // select section
        let playerForm = document.createElement("form");
        let selectContainer = document.createElement("div");
        selectContainer.classList.add("select-container");
        playerForm.appendChild(selectContainer);
        playerDiv.appendChild(playerForm);

        // eating rate
        let eatingDiv = document.createElement("div");

        let eatingLabel = document.createElement("label");
        eatingLabel.innerHTML = "FOOD: ";
        eatingLabel.setAttribute("for", player.name + "-eating-rate");

        let eatingSelect = document.createElement("select");
        eatingSelect.id = player.name + "-eating-rate";
        eatingSelect.setAttribute("name", player.name + "eatingRate");
        eatingSelect.value = player.eatingRate;

        let eatOption0 = document.createElement("option");
        eatOption0.value = "0";
        eatOption0.innerHTML = "0 lb/day";

        let eatOption1 = document.createElement("option");
        eatOption1.value = "0.5";
        eatOption1.innerHTML = "0.5 lb/day";

        let eatOption2 = document.createElement("option");
        eatOption2.value = "1";
        eatOption2.innerHTML = "1 lb/day";

        // adding eating rate div
        eatingSelect.appendChild(eatOption0);
        eatingSelect.appendChild(eatOption1);
        eatingSelect.appendChild(eatOption2);
        eatingDiv.appendChild(eatingLabel);
        eatingDiv.appendChild(eatingSelect);
        selectContainer.appendChild(eatingDiv);

        // drinking rate
        let drinkingDiv = document.createElement("div");

        let drinkingLabel = document.createElement("label");
        drinkingLabel.innerHTML = "H2O: ";
        drinkingLabel.setAttribute("for", player.name + "-drinking-rate");

        let drinkingSelect = document.createElement("select");
        drinkingSelect.id = player.name + "-drinking-rate";
        drinkingSelect.setAttribute("name", player.name + "drinkingRate");

        let drinkOption0 = document.createElement("option");
        drinkOption0.value = "0";
        drinkOption0.innerHTML = "0 gal/day";

        let drinkOption1 = document.createElement("option");
        drinkOption1.value = "0.5";
        drinkOption1.innerHTML = "0.5 gal/day";

        let drinkOption2 = document.createElement("option");
        drinkOption2.value = "1";
        drinkOption2.innerHTML = "1 gal/day";

        let drinkOption3 = document.createElement("option");
        drinkOption3.value = "2";
        drinkOption3.innerHTML = "2 gal/day";

        // adding drinking rate div
        drinkingSelect.appendChild(drinkOption0);
        drinkingSelect.appendChild(drinkOption1);
        drinkingSelect.appendChild(drinkOption2);
        drinkingSelect.appendChild(drinkOption3);
        drinkingDiv.appendChild(drinkingLabel);
        drinkingDiv.appendChild(drinkingSelect);
        selectContainer.appendChild(drinkingDiv);

        // marching order
        let marchingDiv = document.createElement("div");

        let marchingLabel = document.createElement("label");
        marchingLabel.innerHTML = "ORDER: ";
        marchingLabel.setAttribute("for", player.name + "-marching-order");

        let marchingSelect = document.createElement("select");
        marchingSelect.id = player.name + "-marching-order";
        marchingSelect.setAttribute("name", player.name + "marchingOrder");

        let marchOption0 = document.createElement("option");
        marchOption0.value = "Front";
        marchOption0.innerHTML = "Front";

        let marchOption1 = document.createElement("option");
        marchOption1.value = "Middle";
        marchOption1.innerHTML = "Middle";

        let marchOption2 = document.createElement("option");
        marchOption2.value = "Back";
        marchOption2.innerHTML = "Back";

        // adding marching order div
        marchingSelect.appendChild(marchOption0);
        marchingSelect.appendChild(marchOption1);
        marchingSelect.appendChild(marchOption2);
        marchingDiv.appendChild(marchingLabel);
        marchingDiv.appendChild(marchingSelect);
        selectContainer.appendChild(marchingDiv);

        // lifestyle
        let lifestyleDiv = document.createElement("div");

        let lifestyleLabel = document.createElement("label");
        lifestyleLabel.innerHTML = "LIFE: ";
        lifestyleLabel.setAttribute("for", player.name + "-lifestyle");

        let lifestyleSelect = document.createElement("select");
        lifestyleSelect.id = player.name + "-lifestyle";
        lifestyleSelect.setAttribute("name", player.name + "lifestyle");

        let lifestyleOption0 = document.createElement("option");
        lifestyleOption0.value = "Squalid";
        lifestyleOption0.innerHTML = "Squalid";

        let lifestyleOption1 = document.createElement("option");
        lifestyleOption1.value = "Poor";
        lifestyleOption1.innerHTML = "Poor";

        let lifestyleOption2 = document.createElement("option");
        lifestyleOption2.value = "Modest";
        lifestyleOption2.innerHTML = "Modest";

        let lifestyleOption3 = document.createElement("option");
        lifestyleOption3.value = "Comfortable";
        lifestyleOption3.innerHTML = "Comfortable";

        let lifestyleOption4 = document.createElement("option");
        lifestyleOption4.value = "Wealthy";
        lifestyleOption4.innerHTML = "Wealthy";

        let lifestyleOption5 = document.createElement("option");
        lifestyleOption5.value = "Aristocratic";
        lifestyleOption5.innerHTML = "Aristocratic";

        // adding lifestyle rate div
        lifestyleSelect.appendChild(lifestyleOption0);
        lifestyleSelect.appendChild(lifestyleOption1);
        lifestyleSelect.appendChild(lifestyleOption2);
        lifestyleSelect.appendChild(lifestyleOption3);
        lifestyleSelect.appendChild(lifestyleOption4);
        lifestyleSelect.appendChild(lifestyleOption5);
        lifestyleDiv.appendChild(lifestyleLabel);
        lifestyleDiv.appendChild(lifestyleSelect);
        selectContainer.appendChild(lifestyleDiv);

        // button bar
        let buttonDiv = document.createElement("div");
        buttonDiv.classList.add("player-btn-bar");

        // eat button
        let eatBtnDiv = document.createElement("div");
        let eatBtn = document.createElement("button");
        eatBtn.innerHTML = "Eat";
        eatBtnDiv.appendChild(eatBtn);

        // drink button
        let drinkBtnDiv = document.createElement("div");
        let drinkBtn = document.createElement("button");
        drinkBtn.innerHTML = "Drink";
        drinkBtnDiv.appendChild(drinkBtn);

        // add buttons to block
        buttonDiv.appendChild(eatBtnDiv);
        buttonDiv.appendChild(drinkBtnDiv);
        playerDiv.appendChild(buttonDiv);

        // hidden stats
        let hiddenObject = document.createElement("p");
        hiddenObject.id = player.name + "-hidden-data";
        hiddenObject.classList.add("hidden-object-data");
        hiddenObject.innerHTML = JSON.stringify(player);
        playerDiv.appendChild(hiddenObject);


        // add block to grid
        let playerGrid = document.getElementById("player-grid");
        playerGrid.appendChild(playerDiv);

        // set selects
        lifestyleSelect.value = player.lifestyle;
        marchingSelect.value = player.order;
        drinkingSelect.value = player.drinkingRate;
        eatingSelect.value = player.eatingRate;
    }

    function checkGridForDuplicates(name, playerGrid)
    {
        for (let i = 0; i < playerGrid.childElementCount; i++)
        {
            let currentBlock = playerGrid.children[i].id;
            if (currentBlock === name)
            {
                // duplicate found
                return true;
            }
        }

        // no duplicate
        return false;
    }

    function collectPlayersToAdd()
    {
        let playersToAdd = [];
        let playerList = document.getElementById("player-list");
        let count = playerList.childElementCount;

        for (let i = 0; i < count; i++)
        {
            // if box is checked, add player json as object to be added
            let currentPlayer = playerList.children[i];

            // skip if hr tag
            if (currentPlayer.tagName === "HR")
            {
                continue;
            }

            let checkbox = currentPlayer.getElementsByTagName("input")[0];
            if (checkbox.checked)
            {
                // parse json from hidden paragraph and push
                let playerJSON = JSON.parse(currentPlayer.getElementsByTagName("p")[0].innerHTML);
                playersToAdd.push(playerJSON);
            }
        }

        // check that there are enough empty blocks to add these players
        let status = document.getElementById("player-status");
        let playerGrid = document.getElementById("player-grid");
        let currentBlockCount = playerGrid.childElementCount;

        if (playersToAdd.length + currentBlockCount > 8)
        {
            status.innerHTML = "There are not enough empty slots.";
        }
        else
        {
            let addCount = playersToAdd.length;
            for (let i = 0; i < playersToAdd.length; i++)
            {
                // skip if player has already been added
                if (checkGridForDuplicates(playersToAdd[i].name, playerGrid))
                {
                    addCount--;
                    continue;
                }

                insertPlayerBlock(playersToAdd[i]);
            }
            status.innerHTML = addCount + " players added";
        }
    }

    function displayPlayerList(playerList)
    {
        // no items in list
        if (playerList.length === 0)
        {
            // hide the loader
            let loader = document.getElementById("player-list-loader");
            loader.style.display = "none";

            // update status
            document.getElementById("player-status").innerHTML = "No players created.";
        }
        else
        {
            // hide the loader
            let loader = document.getElementById("player-list-loader");
            loader.style.display = "none";

            // update status
            document.getElementById("player-status").innerHTML = "Displaying " + playerList.length + " players."; 

            // create a div to contain the list
            let listDiv = document.createElement("div");
            listDiv.id = "player-list";
            let targetDiv = document.getElementById("player-collapse-target");
            insertAfter(listDiv, targetDiv);

            for (let i = 0; i < playerList.length; i++)
            {
                let newDiv = document.createElement("div");         // create new div
                newDiv.id = "player-" + playerList[i].name;

                let newButton = document.createElement("h3");       // create button to place in the div
                newButton.innerHTML = playerList[i].name;           // add text to the button
                newButton.classList.add("name-row");

                newDiv.appendChild(newButton);                      // attach button to parent div

                // checkbox
                let newCheck = document.createElement("input");
                newCheck.setAttribute("type", "checkbox");
                newCheck.value = "checked";
                newCheck.classList.add("name-row");
                newCheck.classList.add("name-checkbox");

                // checkbox to div
                newDiv.appendChild(newCheck);

                // storing the json for later
                let hiddenObject = document.createElement("p");
                hiddenObject.classList.add("hidden-object-data");
                hiddenObject.innerHTML = JSON.stringify(playerList[i]);
                newDiv.appendChild(hiddenObject);

                // add div to playerList div
                listDiv.appendChild(newDiv);

                // add an hr if this isn't the last child
                if (i < playerList.length - 1)
                {
                    let newHr = document.createElement("hr");
                    listDiv.appendChild(newHr);
                }
            }
        }
    }

    function loadPlayerList()
    {
        // if the playerList div exists, delete it
        if (document.contains(document.getElementById("player-list")))
        {
            document.getElementById("player-list").remove();
        }

        // show loading circle
        let loader = document.getElementById("player-list-loader");
        loader.style.display = "block";

        // display loading message
        document.getElementById("player-status").innerHTML = "Loading player list...";

        // load in array and pass to display function
        google.script.run.withSuccessHandler(displayPlayerList).generateObjectArray('DMAssistantPlayers', 'playerList.json');
    }

    function addNarratorMessage(message)
    {
        let narrator = document.getElementById("narrator");
        let updateText = document.createElement("p");
        updateText.classList.add("message");
        updateText.innerHTML = "> " + message;
        narrator.appendChild(updateText);

        updateText.scrollIntoView();
    }

    function clearNarrator()
    {
        let messages = document.getElementsByClassName("message");
        while (messages[0])
        {
            messages[0].remove();
        }
    }

    function storeEncounterList(objectArray, terrain)
    {
        // get the paragraph for this terrain
        let list = document.getElementById(terrain);

        // turn objectArray to string
        let arrayString = JSON.stringify(objectArray);
        
        // push to paragraph
        list.innerHTML = arrayString;

        addNarratorMessage(terrain + "... done.");
    }

    function loadEncounterLists()
    {
        // display loading message
        addNarratorMessage("Loading random encounter lists...");

        // load in array and pass to display function
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Arctic").selectEncounterTerrain("Arctic");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Coastal").selectEncounterTerrain("Coastal");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Desert").selectEncounterTerrain("Desert");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Forest").selectEncounterTerrain("Forest");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Grassland").selectEncounterTerrain("Grassland");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Hill").selectEncounterTerrain("Hill");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Mountain").selectEncounterTerrain("Mountain");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Swamp").selectEncounterTerrain("Swamp");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Underdark").selectEncounterTerrain("Underdark");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Underwater").selectEncounterTerrain("Underwater");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Urban").selectEncounterTerrain("Urban");
    }

    function loadTrackerLists()
    {
        loadPlayerList();
        loadEncounterLists();
    }

    // -------------- TRAVEL ---------------- //
    let time = 24; // 24 hour cycles
    let totalMilesCovered = 0; // miles that are covered in this travel session

    // marching order
    let frontRank = [];
    let middleRank = [];
    let backRank = [];

    function getPlayerStats()
    {
        players = [];

        // access grid
        let playerGrid = document.getElementById("player-grid");

        // loop through players and save their hidden jsons
        for (let i = 0; i < playerGrid.childElementCount; i++)
        {
            let currentBlock = playerGrid.children[i].id;
            let data = JSON.parse(document.getElementById(currentBlock + "-hidden-data").innerHTML);
            players.push(data);
        }

        return players;
    }

    function updatePlayerBlock(player)
    {
        // hunger
        let hunger = document.getElementById(player.name + "-hunger");
        hunger.innerHTML = "<b>Hunger Status: </b>" + player.hunger;

        // thirst
        let thirst = document.getElementById(player.name + "-thirst");
        thirst.innerHTML = "<b>Hydration Status: </b>" + player.thirst;

        // exhaustion
        let exhaustion = document.getElementById(player.name + "-exhaustion");
        exhaustion.innerHTML = "<b>Exhaustion Level: </b>" + player.exhaustion;

    }

    function calculatePartyNeeds(players)
    {
        // get food stores
        let foodStores = parseInt(document.getElementById("food").value);
        console.log("Food stores: " + foodStores + " lbs");
        
        // feed each player according to their eating rate
        for (let i = 0; i < players.length; i++)
        {
            let player = players[i];
            console.log("Calcualating needs for " + player.name);

            let foodToEat = parseInt(player.eatingRate);
            console.log(player.name + " needs " + foodToEat + " pounds of food today.");

            if (foodToEat === 0)
            {
                console.log("The player's eating rate is 0.");
                // player does not eat today
                player.maxDaysHungry--;

                // set player hunger to HUNGRY
                player.hunger = "Hungry";
            }
            else
            {
                if (foodStores - foodToEat >= 0)
                {
                    console.log("Food stores after conditional: " + foodStores);
                    console.log("There is enough food to eat")

                    foodStores -= foodToEat;                    // decrease stores
                    console.log("New food stores: " + foodStores);

                    document.getElementById("food").value = foodStores;
                    player.maxDaysHungry = parseInt(player.conmod) + 3;   // reset player food counter
                    player.hunger = "Satiated";
                }
                else
                {
                    // player does not eat today
                    player.maxDaysHungry--;

                    // set player hunger to HUNGRY
                    player.hunger = "Hungry";
                }
            }

            if (player.maxDaysHungry <= 0)
            {
                // if player is starving, increase exhaustion
                if (player.exhaustion < 6)
                {
                    player.exhaustion = parseInt(player.exhaustion) + 1;
                }
                
                // set player hunger to STARVING
                player.hunger = "Starving";

                addNarratorMessage(player.name + " is starving.");
            }

            // water
        }

        
        // save player jsons
        for (let i = 0; i < players.length; i++)
        {
            // visible data
            let player = players[i];
            updatePlayerBlock(player);

            // hidden data
            let playerString = JSON.stringify(player);
            let para = document.getElementById(player.name + "-hidden-data");
            para.innerHTML = playerString;
        }
        
    }

    function travel()
    {
        // get player data
        let players = getPlayerStats();

        if (players.length === 0)
        {
            addNarratorMessage("An empty party cannot move!");
        }
        else
        {
            // --- Party Controls --- //
            let partyForm = document.getElementById("party-form");

            // travel speed and miles covered in an hour
            let travelSpeed = partyForm.speed.value;
            let milesCovered = 0;

            switch (travelSpeed)
            {
                case "fast":
                    milesCovered = 4;
                    break;
                case "normal":
                    milesCovered = 3;
                    break;
                case "slow":
                    milesCovered = 2;
                    break;
            }

            // cut milesCovered in half if rough terrain
            if (partyForm.roughCheck.checked)
            {
                milesCovered /= 2.0;
            }

            // increase total miles
            totalMilesCovered += milesCovered;

            // terrain
            let terrain = partyForm.terrain.value;

            // move party
            addNarratorMessage(terrain + ": The party travels " + milesCovered + " miles in one hour.");
            addNarratorMessage("Total distanced covered: " + totalMilesCovered + " miles");

            // if a day has passed, do food, water, and exhaustion calculations
            time--;
            if (time <= 0)
            {
                addNarratorMessage("The day has passed.");
                time = 24;
                calculatePartyNeeds(players);
            }
            else
            {
                addNarratorMessage("Time until day passes: " + time + " hours");
            }

            // random encounter chance
            let encounterChance = partyForm.encounterChance.value;
            let roll = Math.floor(Math.random() * 100) + 1; // returns a random integer from 1 to 100
            if (roll <= encounterChance)
            {
                // random encounter!
                let encounterList = JSON.parse(document.getElementById(terrain).innerHTML);

                // randomly choose an encounter from the list
                let numEncounters = encounterList.length;
                let randomIndex = Math.floor(Math.random() * numEncounters); // returns an integer from 0 to numEncounters - 1
                let encounter = encounterList[randomIndex];

                // print ambush message
                if (encounter.isAmbush)
                {
                    addNarratorMessage("Ambush!");

                    // if party is slow, print stealthy message
                    if (travelSpeed === "slow")
                    {
                        addNarratorMessage("The party has a chance to sneak.");
                    }

                    // TODO: get highest passive perceptions in front and back ranks
                }

                // print description
                addNarratorMessage(encounter.description);
            }



        }
    }

</script>