<script>

    // call on its own to insert a new element after the reference
    function insertAfter(newNode, referenceNode)
    {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }

    /* ADD PLAYER MODAL --------------------------------------*/
    var modal = document.getElementById("add-player-modal");

    // Get the button that opens the modal
    var btn = document.getElementById("insert-player-btn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    btn.onclick = function() {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    /*--------------------------------------------------------*/

    function insertPlayerBlock(player)
    {
        // create player block div
        let playerDiv = document.createElement("div");
        playerDiv.classList.add("player-block");
        playerDiv.id = player.name;

        // header
        let playerName = document.createElement("h1");
        playerName.innerHTML = player.name;
        playerDiv.appendChild(playerName);

        // passive perception
        let perception = document.createElement("p");
        perception.id = player.name + "-perception";
        perception.innerHTML = "<b>Passive Perception: </b>" + player.perception;
        playerDiv.appendChild(perception);

        // conmod
        let conmod = document.createElement("p");
        conmod.id = player.name + "-conmod";
        conmod.innerHTML = "<b>Constitution Modifier: </b>" + player.conmod;
        playerDiv.appendChild(conmod);

        // hunger
        let hunger = document.createElement("p");
        hunger.id = player.name + "-hunger";
        hunger.innerHTML = "<b>Hunger Status: </b>" + player.hunger;
        playerDiv.appendChild(hunger);

        // thirst
        let thirst = document.createElement("p");
        thirst.id = player.name + "-thirst";
        thirst.innerHTML = "<b>Hydration Status: </b>" + player.thirst;
        playerDiv.appendChild(thirst);

        // exhaustion
        let exhaustion = document.createElement("p");
        exhaustion.id = player.name + "-exhaustion";
        exhaustion.innerHTML = "<b>Exhaustion Level: </b>" + player.exhaustion;
        playerDiv.appendChild(exhaustion);

        // select section
        let playerForm = document.createElement("form");
        let selectContainer = document.createElement("div");
        selectContainer.classList.add("select-container");
        playerForm.appendChild(selectContainer);
        playerDiv.appendChild(playerForm);

        // eating rate
        let eatingDiv = document.createElement("div");

        let eatingLabel = document.createElement("label");
        eatingLabel.innerHTML = "FOOD: ";
        eatingLabel.setAttribute("for", player.name + "-eating-rate");

        let eatingSelect = document.createElement("select");
        eatingSelect.id = player.name + "-eating-rate";
        eatingSelect.setAttribute("name", player.name + "eatingRate");
        eatingSelect.value = player.eatingRate;

        let eatOption0 = document.createElement("option");
        eatOption0.value = "0";
        eatOption0.innerHTML = "0 lb/day";

        let eatOption1 = document.createElement("option");
        eatOption1.value = "0.5";
        eatOption1.innerHTML = "0.5 lb/day";

        let eatOption2 = document.createElement("option");
        eatOption2.value = "1";
        eatOption2.innerHTML = "1 lb/day";

        // adding eating rate div
        eatingSelect.appendChild(eatOption0);
        eatingSelect.appendChild(eatOption1);
        eatingSelect.appendChild(eatOption2);
        eatingDiv.appendChild(eatingLabel);
        eatingDiv.appendChild(eatingSelect);
        selectContainer.appendChild(eatingDiv);

        // drinking rate
        let drinkingDiv = document.createElement("div");

        let drinkingLabel = document.createElement("label");
        drinkingLabel.innerHTML = "H2O: ";
        drinkingLabel.setAttribute("for", player.name + "-drinking-rate");

        let drinkingSelect = document.createElement("select");
        drinkingSelect.id = player.name + "-drinking-rate";
        drinkingSelect.setAttribute("name", player.name + "drinkingRate");

        let drinkOption0 = document.createElement("option");
        drinkOption0.value = "0";
        drinkOption0.innerHTML = "0 gal/day";

        let drinkOption1 = document.createElement("option");
        drinkOption1.value = "0.5";
        drinkOption1.innerHTML = "0.5 gal/day";

        let drinkOption2 = document.createElement("option");
        drinkOption2.value = "1";
        drinkOption2.innerHTML = "1 gal/day";

        let drinkOption3 = document.createElement("option");
        drinkOption3.value = "2";
        drinkOption3.innerHTML = "2 gal/day";

        // adding drinking rate div
        drinkingSelect.appendChild(drinkOption0);
        drinkingSelect.appendChild(drinkOption1);
        drinkingSelect.appendChild(drinkOption2);
        drinkingSelect.appendChild(drinkOption3);
        drinkingDiv.appendChild(drinkingLabel);
        drinkingDiv.appendChild(drinkingSelect);
        selectContainer.appendChild(drinkingDiv);

        // marching order
        let marchingDiv = document.createElement("div");

        let marchingLabel = document.createElement("label");
        marchingLabel.innerHTML = "ORDER: ";
        marchingLabel.setAttribute("for", player.name + "-marching-order");

        let marchingSelect = document.createElement("select");
        marchingSelect.id = player.name + "-marching-order";
        marchingSelect.setAttribute("name", player.name + "marchingOrder");

        let marchOption0 = document.createElement("option");
        marchOption0.value = "Front";
        marchOption0.innerHTML = "Front";

        let marchOption1 = document.createElement("option");
        marchOption1.value = "Middle";
        marchOption1.innerHTML = "Middle";

        let marchOption2 = document.createElement("option");
        marchOption2.value = "Back";
        marchOption2.innerHTML = "Back";

        // adding marching order div
        marchingSelect.appendChild(marchOption0);
        marchingSelect.appendChild(marchOption1);
        marchingSelect.appendChild(marchOption2);
        marchingDiv.appendChild(marchingLabel);
        marchingDiv.appendChild(marchingSelect);
        selectContainer.appendChild(marchingDiv);

        // lifestyle
        let lifestyleDiv = document.createElement("div");

        let lifestyleLabel = document.createElement("label");
        lifestyleLabel.innerHTML = "LIFE: ";
        lifestyleLabel.setAttribute("for", player.name + "-lifestyle");

        let lifestyleSelect = document.createElement("select");
        lifestyleSelect.id = player.name + "-lifestyle";
        lifestyleSelect.setAttribute("name", player.name + "lifestyle");

        let lifestyleOption0 = document.createElement("option");
        lifestyleOption0.value = "Squalid";
        lifestyleOption0.innerHTML = "Squalid";

        let lifestyleOption1 = document.createElement("option");
        lifestyleOption1.value = "Poor";
        lifestyleOption1.innerHTML = "Poor";

        let lifestyleOption2 = document.createElement("option");
        lifestyleOption2.value = "Modest";
        lifestyleOption2.innerHTML = "Modest";

        let lifestyleOption3 = document.createElement("option");
        lifestyleOption3.value = "Comfortable";
        lifestyleOption3.innerHTML = "Comfortable";

        let lifestyleOption4 = document.createElement("option");
        lifestyleOption4.value = "Wealthy";
        lifestyleOption4.innerHTML = "Wealthy";

        let lifestyleOption5 = document.createElement("option");
        lifestyleOption5.value = "Aristocratic";
        lifestyleOption5.innerHTML = "Aristocratic";

        // adding lifestyle rate div
        lifestyleSelect.appendChild(lifestyleOption0);
        lifestyleSelect.appendChild(lifestyleOption1);
        lifestyleSelect.appendChild(lifestyleOption2);
        lifestyleSelect.appendChild(lifestyleOption3);
        lifestyleSelect.appendChild(lifestyleOption4);
        lifestyleSelect.appendChild(lifestyleOption5);
        lifestyleDiv.appendChild(lifestyleLabel);
        lifestyleDiv.appendChild(lifestyleSelect);
        selectContainer.appendChild(lifestyleDiv);

        // button bar
        let buttonDiv = document.createElement("div");
        buttonDiv.classList.add("player-btn-bar");

        // increase exhaustion button
        let exBtnDiv = document.createElement("div");
        let exBtn = document.createElement("button");
        exBtn.innerHTML = "+ Exhaustion";
        exBtn.setAttribute("onclick", "increaseExhaustion('" + player.name + "', 1)");
        exBtnDiv.appendChild(exBtn);

        // decrease exhaustion button
        let decExBtnDiv = document.createElement("div");
        let decExBtn = document.createElement("button");
        decExBtn.innerHTML = "- Exhaustion";
        decExBtn.setAttribute("onclick", "increaseExhaustion('" + player.name + "', -1)");
        decExBtnDiv.appendChild(decExBtn);

        // add buttons to block
        buttonDiv.appendChild(exBtnDiv);
        buttonDiv.appendChild(decExBtnDiv);
        playerDiv.appendChild(buttonDiv);

        // hidden stats
        let hiddenObject = document.createElement("p");
        hiddenObject.id = player.name + "-hidden-data";
        hiddenObject.classList.add("hidden-object-data");
        hiddenObject.innerHTML = JSON.stringify(player);
        playerDiv.appendChild(hiddenObject);


        // add block to grid
        let playerGrid = document.getElementById("player-grid");
        playerGrid.appendChild(playerDiv);

        // set selects
        lifestyleSelect.value = player.lifestyle;
        marchingSelect.value = player.order;
        drinkingSelect.value = player.drinkingRate;
        eatingSelect.value = player.eatingRate;
    }

    function increaseExhaustion(playerID, amount)
    {
        // pull hidden data
        let player = JSON.parse(document.getElementById(playerID + "-hidden-data").innerHTML);

        // increase exhaustion
        let exhaustion = parseInt(player.exhaustion);
        exhaustion += amount;
        player.exhaustion = exhaustion;

        // update visible block
        updatePlayerBlock(player);

        // update hidden data
        let playerString = JSON.stringify(player);
        let para = document.getElementById(player.name + "-hidden-data");
        para.innerHTML = playerString;
    }

    function checkGridForDuplicates(name, playerGrid)
    {
        for (let i = 0; i < playerGrid.childElementCount; i++)
        {
            let currentBlock = playerGrid.children[i].id;
            if (currentBlock === name)
            {
                // duplicate found
                return true;
            }
        }

        // no duplicate
        return false;
    }

    function collectPlayersToAdd()
    {
        let playersToAdd = [];
        let playerList = document.getElementById("player-list");
        let count = playerList.childElementCount;

        for (let i = 0; i < count; i++)
        {
            // if box is checked, add player json as object to be added
            let currentPlayer = playerList.children[i];

            // skip if hr tag
            if (currentPlayer.tagName === "HR")
            {
                continue;
            }

            let checkbox = currentPlayer.getElementsByTagName("input")[0];
            if (checkbox.checked)
            {
                // parse json from hidden paragraph and push
                let playerJSON = JSON.parse(currentPlayer.getElementsByTagName("p")[0].innerHTML);
                playersToAdd.push(playerJSON);
            }
        }

        // check that there are enough empty blocks to add these players
        let status = document.getElementById("player-status");
        let playerGrid = document.getElementById("player-grid");
        let currentBlockCount = playerGrid.childElementCount;

        if (playersToAdd.length + currentBlockCount > 8)
        {
            status.innerHTML = "There are not enough empty slots.";
        }
        else
        {
            let addCount = playersToAdd.length;
            for (let i = 0; i < playersToAdd.length; i++)
            {
                // skip if player has already been added
                if (checkGridForDuplicates(playersToAdd[i].name, playerGrid))
                {
                    addCount--;
                    continue;
                }

                insertPlayerBlock(playersToAdd[i]);
            }
            status.innerHTML = addCount + " players added";
        }
    }

    function displayPlayerList(playerList)
    {
        // no items in list
        if (playerList.length === 0)
        {
            // hide the loader
            let loader = document.getElementById("player-list-loader");
            loader.style.display = "none";

            // update status
            document.getElementById("player-status").innerHTML = "No players created.";
        }
        else
        {
            // hide the loader
            let loader = document.getElementById("player-list-loader");
            loader.style.display = "none";

            // update status
            document.getElementById("player-status").innerHTML = "Displaying " + playerList.length + " players."; 

            // create a div to contain the list
            let listDiv = document.createElement("div");
            listDiv.id = "player-list";
            let targetDiv = document.getElementById("player-collapse-target");
            insertAfter(listDiv, targetDiv);

            for (let i = 0; i < playerList.length; i++)
            {
                let newDiv = document.createElement("div");         // create new div
                newDiv.id = "player-" + playerList[i].name;

                let newButton = document.createElement("h3");       // create button to place in the div
                newButton.innerHTML = playerList[i].name;           // add text to the button
                newButton.classList.add("name-row");

                newDiv.appendChild(newButton);                      // attach button to parent div

                // checkbox
                let newCheck = document.createElement("input");
                newCheck.setAttribute("type", "checkbox");
                newCheck.value = "checked";
                newCheck.classList.add("name-row");
                newCheck.classList.add("name-checkbox");

                // checkbox to div
                newDiv.appendChild(newCheck);

                // storing the json for later
                let hiddenObject = document.createElement("p");
                hiddenObject.classList.add("hidden-object-data");
                hiddenObject.innerHTML = JSON.stringify(playerList[i]);
                newDiv.appendChild(hiddenObject);

                // add div to playerList div
                listDiv.appendChild(newDiv);

                // add an hr if this isn't the last child
                if (i < playerList.length - 1)
                {
                    let newHr = document.createElement("hr");
                    listDiv.appendChild(newHr);
                }
            }
        }
    }

    function loadPlayerList()
    {
        // if the playerList div exists, delete it
        if (document.contains(document.getElementById("player-list")))
        {
            document.getElementById("player-list").remove();
        }

        // show loading circle
        let loader = document.getElementById("player-list-loader");
        loader.style.display = "block";

        // display loading message
        document.getElementById("player-status").innerHTML = "Loading player list...";

        // load in array and pass to display function
        google.script.run.withSuccessHandler(displayPlayerList).generateObjectArray('DMAssistantPlayers', 'playerList.json');
    }

    function addNarratorMessage(message)
    {
        let narrator = document.getElementById("narrator");
        let updateText = document.createElement("p");
        updateText.classList.add("message");
        updateText.innerHTML = "> " + message;
        narrator.appendChild(updateText);

        updateText.scrollIntoView();
    }

    function clearNarrator()
    {
        let messages = document.getElementsByClassName("message");
        while (messages[0])
        {
            messages[0].remove();
        }
    }

    function storeEncounterList(objectArray, terrain)
    {
        // get the paragraph for this terrain
        let list = document.getElementById(terrain);

        // turn objectArray to string
        let arrayString = JSON.stringify(objectArray);
        
        // push to paragraph
        list.innerHTML = arrayString;

        addNarratorMessage(terrain + "... done.");
    }

    function loadEncounterLists()
    {
        // display loading message
        addNarratorMessage("Loading random encounter lists...");

        // load in array and pass to display function
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Arctic").selectEncounterTerrain("Arctic");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Coastal").selectEncounterTerrain("Coastal");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Desert").selectEncounterTerrain("Desert");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Forest").selectEncounterTerrain("Forest");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Grassland").selectEncounterTerrain("Grassland");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Hill").selectEncounterTerrain("Hill");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Mountain").selectEncounterTerrain("Mountain");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Swamp").selectEncounterTerrain("Swamp");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Underdark").selectEncounterTerrain("Underdark");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Underwater").selectEncounterTerrain("Underwater");
        google.script.run.withSuccessHandler(storeEncounterList).withUserObject("Urban").selectEncounterTerrain("Urban");
    }

    function loadTrackerLists()
    {
        loadPlayerList();
        loadEncounterLists();
    }

    // -------------- TRAVEL ---------------- //
    var time = 24; // 24 hour cycles
    var totalMilesCovered = 0; // miles that are covered in this travel session

    // marching order
    let frontRank = [];
    let middleRank = [];
    let backRank = [];

    function getPlayerStats()
    {
        players = [];

        // access grid
        let playerGrid = document.getElementById("player-grid");

        // loop through players and save their hidden jsons
        for (let i = 0; i < playerGrid.childElementCount; i++)
        {
            let currentBlock = playerGrid.children[i].id;
            let data = JSON.parse(document.getElementById(currentBlock + "-hidden-data").innerHTML);
            players.push(data);
        }

        return players;
    }

    function updatePlayerBlock(player)
    {
        // hunger
        let hunger = document.getElementById(player.name + "-hunger");
        hunger.innerHTML = "<b>Hunger Status: </b>" + player.hunger;

        // thirst
        let thirst = document.getElementById(player.name + "-thirst");
        thirst.innerHTML = "<b>Hydration Status: </b>" + player.thirst;

        // exhaustion
        let exhaustion = document.getElementById(player.name + "-exhaustion");

        if (player.exhaustion > 6)
        {
            player.exhaustion = 6;
        }
        else if (player.exhaustion < 0)
        {
            player.exhaustion = 0;
        }
        exhaustion.innerHTML = "<b>Exhaustion Level: </b>" + player.exhaustion;
    }

    function playerEat(player, foodStores)
    {
        let foodToEat = parseFloat(document.getElementById(player.name + "-eating-rate").value);

        if (foodToEat === 0)
        {
            // player does not eat today
            player.maxDaysHungry--;

            // set player hunger to HUNGRY
            player.hunger = "Hungry";
        }
        else
        {
            if (foodStores - foodToEat >= 0)
            {
                foodStores -= foodToEat;                    // decrease stores

                document.getElementById("food").value = foodStores;

                if (foodToEat === 1)
                {
                    // full pound of food
                    player.maxDaysHungry = parseInt(player.conmod) + 3;   // reset player food counter
                    player.hunger = "Satiated";
                }
                else
                {
                    // half pound
                    player.maxDaysHungry -= 0.5;
                    player.hunger = "Hungry";
                }
            }
            else
            {
                // player does not eat today
                player.maxDaysHungry--;

                // set player hunger to HUNGRY
                player.hunger = "Hungry";
            }
        }

        if (player.maxDaysHungry <= 0)
        {
            // if player is starving, increase exhaustion
            if (player.exhaustion < 6)
            {
                player.exhaustion = parseInt(player.exhaustion) + 1;
            }
            
            // set player hunger to STARVING
            player.hunger = "Starving";

            addNarratorMessage(player.name + " is starving.");
        }
    }

    function playerDrink(player, waterStores)
    {
        // get player's drinking rate
        let waterToDrink = parseFloat(document.getElementById(player.name + "-drinking-rate").value);

        // get how much water the player needs to drink
        let waterNeeded = 1;
        if (document.getElementById("temperature").value === "Hot")
        {
            waterNeeded = 2;
        }

        if (waterToDrink === 0 || waterStores - waterToDrink < 0)
        {
            // no water today, player increases exhaustion and becomes dehydrated
            player.thirst = "Dehydrated";
            addNarratorMessage(player.name + " is dehydrated.");
            
            if (parseInt(player.exhaustion) > 0)
            {
                player.exhaustion = parseInt(player.exhaustion) + 2;
            }
            else
            {
                player.exhaustion = parseInt(player.exhaustion) + 1;
            }
        }
        else
        {
            // enough water in storage, decrease
            waterStores -= waterToDrink;
            document.getElementById("water").value = waterStores;

            if (waterToDrink < waterNeeded / 2)
            {
                addNarratorMessage(player.name + " is dehydrated.");
                player.thirst = "Dehydrated";

                // drinking less than half, automatically one level
                if (parseInt(player.exhaustion) > 0)
                {
                    player.exhaustion = parseInt(player.exhaustion) + 2;
                }
                else
                {
                    player.exhaustion = parseInt(player.exhaustion) + 1;
                }
            }
            else if (waterToDrink < waterNeeded)
            {
                // less than needed, roll DC 15 con save
                let roll = Math.floor(Math.random() * 20) + 1; // returns a random integer from 1 to 20
                roll += parseInt(player.conmod);               // add player's constitution modifier

                if (roll < 15)
                {
                    addNarratorMessage(player.name + " fails their hydration save with a " + roll + ".");
                    addNarratorMessage(player.name + " is dehydrated.");
                    player.thirst = "Dehydrated";

                    // fail
                    if (parseInt(player.exhaustion) > 0)
                    {
                        player.exhaustion = parseInt(player.exhaustion) + 2;
                    }
                    else
                    {
                        player.exhaustion = parseInt(player.exhaustion) + 1;
                    }
                }
                else
                {
                    // succeed
                    // drinking enough, set hydrated
                    addNarratorMessage(player.name + " passes their hydration save with a " + roll + ".");
                    player.thirst = "Hydrated";
                }
            }
            else
            {
                // drinking enough, set hydrated
                player.thirst = "Hydrated";
            }
        }
    }

    function calculatePartyNeeds(players)
    {
        
        // feed each player according to their eating rate
        for (let i = 0; i < players.length; i++)
        {
            // get food stores
            let foodStores = parseFloat(document.getElementById("food").value);
            let waterStores = parseFloat(document.getElementById("water").value);

            let player = players[i];

            playerEat(player, foodStores);
            playerDrink(player, waterStores);
        }

        
        // save player jsons
        for (let i = 0; i < players.length; i++)
        {
            // visible data
            let player = players[i];
            updatePlayerBlock(player);

            // hidden data
            let playerString = JSON.stringify(player);
            let para = document.getElementById(player.name + "-hidden-data");
            para.innerHTML = playerString;
        }
        
    }

    function updateTimeAndDistance(milesCovered, time)
    {
        let milesPara = document.getElementById("miles");
        let hoursPara = document.getElementById("hours");

        milesPara.innerHTML = "Miles Traveled: " + milesCovered;
        hoursPara.innerHTML = "Hours until new day: " + time;
    }

    function calculateLifestyleDues(players)
    {
        let totalDues = 0;  // returned in gp

        for (let i = 0; i < players.length; i++)
        {
            currentLifestyle = document.getElementById(players[i].name + "-lifestyle").value;

            switch (currentLifestyle)
            {
                case "Squalid":
                    totalDues += 0.1;
                    break;
                case "Poor":
                    totalDues += 0.2;
                    break;
                case "Modest":
                    totalDues += 1;
                    break;
                case "Comfortable":
                    totalDues += 2;
                    break;
                case "Wealthy":
                    totalDues += 4;
                    break;
                case "Aristocratic":
                    totalDues += 10;
                    break;
            }
        }

        totalDues = totalDues.toPrecision(3);

        addNarratorMessage("If the party is in town, they owe " + totalDues + " gp in lifestyle expenses.");
    }

    function getMostPerceptivePlayer(players, order)
    {
        let maxPerception = 0;
        let mostPerspective = "";

        // get all players with the passed order
        for (let i = 0; i < players.length; i++)
        {
            let currentOrder = document.getElementById(players[i].name + "-marching-order").value;

            if (currentOrder === order)
            {
                let currentPerception = parseInt(players[i].perception);

                if (currentPerception > maxPerception)
                {
                    maxPerception = currentPerception;
                    mostPerspective = players[i];
                }
            }
        }
        
        return mostPerspective;
    }

    function travel()
    {
        // get player data
        let players = getPlayerStats();

        if (players.length === 0)
        {
            addNarratorMessage("An empty party cannot move!");
        }
        else
        {
            // --- Party Controls --- //
            let partyForm = document.getElementById("party-form");

            // travel speed and miles covered in an hour
            let travelSpeed = partyForm.speed.value;
            let milesCovered = 0;

            switch (travelSpeed)
            {
                case "fast":
                    milesCovered = 4;
                    break;
                case "normal":
                    milesCovered = 3;
                    break;
                case "slow":
                    milesCovered = 2;
                    break;
            }

            // cut milesCovered in half if rough terrain
            if (partyForm.roughCheck.checked)
            {
                milesCovered /= 2.0;
            }

            // increase total miles
            totalMilesCovered += milesCovered;

            // terrain
            let terrain = partyForm.terrain.value;

            // if a day has passed, do food, water, and exhaustion calculations
            time--;
            if (time <= 0)
            {
                clearNarrator();
                addNarratorMessage("The day has passed.");
                time = 24;
                calculatePartyNeeds(players);
                calculateLifestyleDues(players);
            }

            // move party
            updateTimeAndDistance(totalMilesCovered, time);

            // random encounter chance
            let encounterChance = partyForm.encounterChance.value;
            let roll = Math.floor(Math.random() * 100) + 1; // returns a random integer from 1 to 100
            if (roll <= encounterChance)
            {
                // random encounter!
                let encounterList = JSON.parse(document.getElementById(terrain).innerHTML);
                
                if (encounterList.length === 0)
                {
                    addNarratorMessage("The DM has not created any " + terrain + " random encounters.");
                }
                else
                {
                    // randomly choose an encounter from the list
                    let numEncounters = encounterList.length;
                    let randomIndex = Math.floor(Math.random() * numEncounters); // returns an integer from 0 to numEncounters - 1
                    let encounter = encounterList[randomIndex];

                    // print ambush message
                    if (encounter.isAmbush)
                    {
                        addNarratorMessage("Ambush!");

                        // if party is slow, print stealthy message
                        if (travelSpeed === "slow")
                        {
                            addNarratorMessage("The party has a chance to sneak.");
                        }

                        // TODO: get highest passive perceptions in front and back ranks
                        let mostPerceptiveFront = getMostPerceptivePlayer(players, "Front");
                        let mostPerceptiveBack = getMostPerceptivePlayer(players, "Back");

                        if (mostPerceptiveFront !== "")
                        {
                            addNarratorMessage(mostPerceptiveFront.name + " has a chance to spot the ambush/trap if it's in front of the party (Perception = " + mostPerceptiveFront.perception + ")");
                        }
                        if (mostPerceptiveBack !== "")
                        {
                            addNarratorMessage(mostPerceptiveBack.name + " has a chance to spot the ambush/trap if it's behind the party (Perception = " + mostPerceptiveBack.perception + ")");
                        }
                    }

                    // print description
                    addNarratorMessage(encounter.description);
                }
            }
            else
            {
                addNarratorMessage("Nothing happens...");
            }
        }
    }

    function setRatesForAll(id, cutID)
    {
        let playerGrid = document.getElementById("player-grid");

        if (playerGrid.childElementCount <= 0)
        {
            addNarratorMessage("No players to set values for.");
        }
        else
        {
            let newVal = document.getElementById(id).value;

            for (let i = 0; i < playerGrid.childElementCount; i++)
            {
                let currentPlayerName = playerGrid.children[i].id;
                let select = document.getElementById(currentPlayerName + cutID);
                select.value = newVal;
            }

            addNarratorMessage('Value "' + newVal + '" set.');
        }
    }

    function checkIfEnoughFood(players)
    {
        let totalFoodToEat = 0;
        let foodStores = parseFloat(document.getElementById("food").value);

        for (let i = 0; i < players.length; i++)
        {
            totalFoodToEat += parseFloat(document.getElementById(players[i].name + "-eating-rate").value);
        }

        if (foodStores >= totalFoodToEat)
        {
            return true;
        }
        
        return false;
    }

    function checkIfEnoughWater(players)
    {
        let totalWaterToDrink = 0;
        let waterStores = parseFloat(document.getElementById("water").value);

        for (let i = 0; i < players.length; i++)
        {
            totalWaterToDrink += parseFloat(document.getElementById(players[i].name + "-drinking-rate").value);
        }

        if (waterStores >= totalWaterToDrink)
        {
            return true;
        }
        
        return false;
    }

    function longRest()
    {
        let players = getPlayerStats();

        if (players.length === 0)
        {
            addNarratorMessage("Cannot rest without a party!");
        }
        else
        {
            // check if enough food/water to feed everyone
            let isFood = checkIfEnoughFood(players);
            let isWater = checkIfEnoughWater(players);

            // if there is, decrease everyone's exhaustion by 1 and set time to 0 (and do the feeding)
            if (isFood && isWater)
            {
                clearNarrator();
                calculateLifestyleDues(players);
                calculatePartyNeeds(players);

                for (let i = 0; i < players.length; i++)
                {
                    increaseExhaustion(players[i].name, -1);
                }

                time = 24;
                updateTimeAndDistance(totalMilesCovered, time);

                // random encounter chance
                let partyForm = document.getElementById("party-form");
                let terrain = partyForm.terrain.value;
                let encounterChance = partyForm.encounterChance.value;
                let roll = Math.floor(Math.random() * 100) + 1; // returns a random integer from 1 to 100
                if (roll <= encounterChance)
                {
                    // random encounter!
                    let encounterList = JSON.parse(document.getElementById(terrain).innerHTML);

                    if (encounterList.length === 0)
                    {
                        addNarratorMessage("The DM has not created any " + terrain + " random encounters.");
                    }
                    else
                    {
                        // randomly choose an encounter from the list
                        let numEncounters = encounterList.length;
                        let randomIndex = Math.floor(Math.random() * numEncounters); // returns an integer from 0 to numEncounters - 1
                        let encounter = encounterList[randomIndex];

                        // print ambush message
                        if (encounter.isAmbush)
                        {
                            addNarratorMessage("Ambush!");
                        }

                        // print description
                        addNarratorMessage(encounter.description);
                    }
                }
                else
                {
                    addNarratorMessage("The party enjoys a quiet long rest.");
                }
            }
            else if (!isFood && isWater)
            {
                addNarratorMessage("Cannot rest without enough food for everyone!");
            }
            else if (!isWater && isFood)
            {
                addNarratorMessage("Cannot rest without enough water for everyone!");
            }
            else
            {
                addNarratorMessage("Cannot rest without enough food and water for everyone!");
            }
        }
    }

    function setNewSelects(players)
    {
        for (let i = 0; i < players.length; i++)
        {
            // eating rate
            players[i].eatingRate = document.getElementById(players[i].name + "-eating-rate").value;

            // drinking rate
            players[i].drinkingRate = document.getElementById(players[i].name + "-drinking-rate").value;

            // order
            players[i].order = document.getElementById(players[i].name + "-marching-order").value;

            // lifestyle
            players[i].lifestyle = document.getElementById(players[i].name + "-lifestyle").value;
        }
    }

    function sendFinishedSavingMessage(response)
    {
        addNarratorMessage("Saving complete!");
    }

    function savePlayersToDrive()
    {
        addNarratorMessage("Saving players... Please do not exit the window.");
        let players = getPlayerStats();
        setNewSelects(players);
        google.script.run.withSuccessHandler(sendFinishedSavingMessage).savePlayers(players);
    }

</script>